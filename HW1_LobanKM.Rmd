---
title: 'Biostat :: Home Work №1'
author: "Loban Konstantin"
date: "2025-04-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Подготовительный этап

Загрузка датасета и необходимых библиотек

```{r cars}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(broom)

df <- read_excel("C:/Users/Лобан Константин/YandexDisk/- По работе/Магистратура/R/pima.xlsx", sheet = "pima")
```

## Задание №1

Рассчитайте число наблюдений, среднее, стандартное отклонение, 1-й и 3-й квартили, минимум и максимум для переменных *glucose, pressure, mass*.

```{r}
df %>% 
  select(glucose , pressure, mass) %>% 
  summarise(across(
    everything(),
    list(
      n_obs = ~sum(!is.na(.)),
      mean = ~mean(., na.rm = TRUE),
      sd = ~sd(., na.rm = TRUE),
      q1 = ~quantile(., 0.25, na.rm = TRUE),
      q3 = ~quantile(., 0.75, na.rm = TRUE),
      min = ~min(., na.rm = TRUE),
      max = ~max(., na.rm = TRUE)
    )
  )) %>%
    pivot_longer(
    everything(),
    names_to = c("variable", "stat"),
    names_sep = "_"
  ) %>%
  pivot_wider(
    names_from = "stat",
    values_from = "value"
  )
```

## Задание №2

Рассчитайте описательную статистику для переменной *diabetes*. Создайте на основе переменной age новую переменную age_group, которая будет отражать следующие возрастные группы: 21–35, 36–49 и 50+. Посчитайте описательную статистику для новой переменной.

```{r}
print("Описательная статистика для diabetes:")
table(df$diabetes) %>% 
  prop.table() %>% 
  round(3) * 100 

# Создание новой переменной
df <- df %>% 
  mutate(age_group = case_when(
    age >= 21 & age <= 35 ~ "21-35",
    age >= 36 & age <= 49 ~ "36-49",
    age >= 50 ~ "50+"
  )) 

print("Описательная статистика для age_group:")
table(df$age_group) %>% 
  prop.table() %>% 
  round(3) * 100  # Процентное распределение

```

## Задание №3

Постройте два ящика с усами для значений *pos* и *neg* соответственно переменной *diabetes*.

```{r}
# Не очень поятно, как построить ящик с усами для категориальной переменной, возможно речь идет про переменную glucose?

ggplot(df, aes(x = diabetes, y = glucose, fill = diabetes)) +
  geom_boxplot() +
  scale_x_discrete(labels = c("pos" = "Есть диабет", "neg" = "Нет диабета")) 
  labs(
    title = "Уровень глюкозы у пациентов с диабетом и без",
    x = "Наличие диабета",
    y = "Уровень глюкозы",
    fill = "Диабет"
  ) 
```

## Задание №4

Рассмотрите следующую статистическую гипотезу.

> Проводят некоторое исследование пациентов с артериальной гипертензией. Предположим, что внедрение нового препарата в среднем лучше снижает их давление по сравнению со стандартной терапией.

-   Задайте *seed* для воспроизводимости результатов (функция *set.seed()*).

-   Задайте размер выборки *sample_size* \<- 30.

-   Задайте значение среднего систолического артериального давления до приема нового препарата и после.

```{r}
# Сгенерим новый датасет
set.seed(42)
df1 <- data.frame(
  patient_id = 1:30,
  group = factor(rep(c("1", "2"), each = 15)),
  # 1 - старое лечение (контроль), 2 - новый препарат (лечение)
  sap_before = round(rnorm(30, mean = 145, sd = 10)),
  sap_after = c(
    round(rnorm(15, mean = 130, sd = 10)),
    round(rnorm(15, mean = 110, sd = 10))
  )
)
# миксанем :)
df1 = df1[sample(30),]
```

Затем:

### Задание №4.1 Сформулируйте нулевую и альтернативную гипотезы.

> **Нулевая гипотеза:** тепень снижения АД для нового препарата не отличается от таковой при стандартной терапии
>
> **Альтернативная:** новый препарат более значительно снижает АД, чем стандартная терапия

### Задание №4.2

Определите уровень значимости.

> ***alpha \< 0.05***

### Задание №4.3

Выберите и примените статистический тест для проверки гипотезы и аргументируйте свой выбор.

```{r}
# для начала проверяем распределение данных
df1_g0 <- df1 %>% 
  filter(group == 1)
df1_g1 <- df1 %>% 
  filter(group == 2)

print("Проверка нормальности распределений:")
shapiro.test(df1_g0$sap_before)$p
shapiro.test(df1_g1$sap_before)$p
shapiro.test(df1_g0$sap_after)$p
shapiro.test(df1_g1$sap_after)$p # вдруг оказалась не нормально распределена

```

```{r}
print("Проверка гипотез:")
print("Способ 1:")
# Способ №1: при сопоставимости исходных характеристик - сравнить целевые показатели
t.test(sap_before ~ group, data = df1)$p.value
wilcox.test(sap_before ~ group, data = df1, paired = FALSE)$p.value

print("Способ 2:")
# Способ №2: сравнение, насколько значимо изменился показатель в двух группах
t.test(df1_g0$sap_before, df1_g0$sap_after, paried = TRUE)$p.value
wilcox.test(df1_g1$sap_before, df1_g1$sap_after, paired = TRUE)$p.value
t.test(df1_g0$sap_before, df1_g0$sap_after, paried = TRUE)$p.value > wilcox.test(df1_g1$sap_before, df1_g1$sap_after, paired = TRUE)$p.value

print("Способ 3:")
# Способ №3: сравнение 95% доверительных интервалов эффекта терапии
# Учитывая ненормальное распределение и малую выборку использован квантильный метод
library(boot)
df1$sap_effect <- df1$sap_after - df1$sap_before
df1 %>%
  group_by(group) %>%
  summarise(
    n = sum(!is.na(sap_effect)),
    mean_effect = mean(sap_effect, na.rm = TRUE),
    se = sd(sap_effect, na.rm = TRUE)/sqrt(n),
    conf.low = mean_effect - qt(0.975, df = n-1)*se,
    conf.high = mean_effect + qt(0.975, df = n-1)*se,
    .groups = "drop"
  )

```

### Задание №4.4

Оцените и прокомментируйте статистическую значимость.

> Учитывая ненормальное распределение одного из показателей (видимо из-за малой выборки), пришлось в ряде случаев применять непараметрические методы
>
> При первом способе мы формально убедились, что можем сравнивать выборки (хотя сопоставимость весьма условная р-значение стремится к 0.05) и при их сравнении не получили статистически значимых отличий.
>
> При втором способе мы ожидали у 2 группы более значимые различия между исходным САД и полученным, однако получили результат даже наоборот. Видимо из-за разных тестов, применяемых к данным.
>
> Наконец, как это делают обычно в РКИ, мы оценили эффект терапии с доверительным интервалом и получили пересечение ДИ, что опять-таки говорит об отсустсвии статистической значимости.
>
> Я бы порекомендовал бы исследователям увеличить выборку, что приведет, во-первых, к нормализации данных и возможности применения параметрических тестов для всех сравнений, во-вторых, сужению доверительных интервалов за счет увеличения выборки, в-третьих, уменьшения влияния случайности на получаемые значения.
